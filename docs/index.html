<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<title>Gamo RPG</title>

<style>
/* â€”â€”â€” å¸ƒå±€ & ä¸»é¢˜ â€”â€”â€” */
body{font-family:sans-serif;max-width:620px;margin:40px auto;padding:0 12px;color:#222}
h2{margin-top:0}
.bubble{background:#f6f6f6;border-radius:8px;padding:12px;margin:8px 0}
button{margin:6px 6px 0 0;padding:6px 14px;border:0;border-radius:6px;
       background:#2563eb;color:#fff;font-size:14px;cursor:pointer}
button:disabled{background:#aaa}

/* â€”â€”â€” Spinner å›ºå®šå±ä¸­ â€”â€”â€” */
#loader{
  display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #2563eb;
  border-radius:50%;animation:spin 1s linear infinite;z-index:9999;
}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

/* â€”â€”â€” è¯­è¨€é€‰æ‹©æ‚¬æµ® â€”â€”â€” */
#langBox{
  position:fixed;top:12px;right:12px;z-index:1000;
  background:#fff;padding:4px 6px;border-radius:6px;
  box-shadow:0 0 4px rgba(0,0,0,.08);font-size:14px;
}
#langBox select{margin-left:4px}
</style>
</head>

<body onload="resetUI()">
<h2>ğŸŒŸ Gamo RPG Demo</h2>

<!-- è¯­è¨€é€‰æ‹© -->
<div id="langBox">
  <label id="langLabel" for="langSel">è¯­è¨€:</label>
  <select id="langSel" onchange="switchLang(this.value)">
    <option value="zh">ä¸­æ–‡</option>
    <option value="en">English</option>
  </select>
</div>

<!-- å…³é”®è¯è¾“å…¥ & å¼€å§‹ -->
<input id="tagInput" style="padding:6px;width:60%" placeholder="è¾“å…¥å…³é”®è¯ï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚â€œç©¿è¶Š,æç¬‘â€">
<button id="startBtn" onclick="start()">å¼€å§‹å†’é™©</button>

<div id="loader"></div>
<h3 id="intro"></h3>      <!-- ğŸŒ ä¸–ç•Œè§‚ + ğŸ¯ ä¸»çº¿ -->
<div id="history"></div> <!-- å‰§æƒ…æ°”æ³¡ -->
<div id="choices"></div> <!-- æŒ‰é’®åŒº -->
<button id="restartBtn" onclick="restart()" style="margin-top:12px">é‡æ–°å¼€å§‹</button>

<script>
/* â€”â€”â€” å…¨å±€å¸¸é‡ / çŠ¶æ€ â€”â€”â€” */
const API  = "https://gamo.onrender.com";
const hist = document.getElementById("history");
const box  = document.getElementById("choices");
const intro= document.getElementById("intro");
const loader = document.getElementById("loader");

const i18n = {
  zh:{ start:"å¼€å§‹å†’é™©", exec:"æ‰§è¡Œ", ending:"ç”Ÿæˆç»“å±€", restart:"é‡æ–°å¼€å§‹",
       placeholder:"è¾“å…¥å…³é”®è¯ï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚â€œç©¿è¶Š,æç¬‘â€", free:"è‡ªç”±è¾“å…¥â€¦"},
  en:{ start:"Start",     exec:"Go",   ending:"End Story", restart:"Restart",
       placeholder:"Enter tags, e.g. isekai, comedy",      free:"Free actionâ€¦"}
};
let lang = localStorage.getItem("lang") || "zh";
let SID = null;

/* â€”â€”â€” å·¥å…·å‡½æ•° â€”â€”â€” */
const t         = k => i18n[lang][k] || k;
const showLoad  = () => loader.style.display="block";
const hideLoad  = () => loader.style.display="none";
const restart   = () => location.reload();

function switchLang(l){
  lang = l; localStorage.setItem("lang", l);
  document.getElementById("langSel").value = l;
  document.getElementById("startBtn").textContent = t("start");
  document.getElementById("restartBtn").textContent = t("restart");
  document.getElementById("tagInput").placeholder  = t("placeholder");
  document.getElementById("langLabel").textContent = (l==="zh")?"è¯­è¨€:":"Language:";
}


function resetUI(){ intro.innerHTML=hist.innerHTML=box.innerHTML=""; }

function add(html){
  hist.insertAdjacentHTML("beforeend", `<div class="bubble">${html}</div>`);
  window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"});
}

/* â€”â€”â€” é€šç”¨ fetch (è‡ªåŠ¨é™„å¸¦ lang & cookie) â€”â€”â€” */
async function api(path, body){
  body = {...body, lang, sid: SID};
  showLoad();
  const res = await fetch(`${API}/${path}`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body),credentials:"include"
  });
  hideLoad();
  if(!res.ok){ alert(await res.text()); throw new Error("api error"); }
  return res.json();
}

/* â€”â€”â€” æ¸²æŸ“é€‰é¡¹ / è‡ªç”±è¾“å…¥ / ç»“å±€æŒ‰é’® â€”â€”â€” */
function renderButtons(opts){
  box.innerHTML = "";

  /* A/B/C é€‰é¡¹ */
  opts.forEach(o=>{
    const b = document.createElement("button");
    b.textContent = `${o.id}. ${o.text}`;
    b.onclick     = ()=>choose(o.id);
    box.appendChild(b);
  });

  if(!opts.length) return;           // é¦–æ¬¡åŠ è½½å¤±è´¥ safety

  /* è‡ªç”±è¾“å…¥ + æ‰§è¡Œ */
  const inp = document.createElement("input");
  inp.id="customInput"; inp.placeholder=t("free"); box.appendChild(inp);

  const exec = document.createElement("button");
  exec.id="execBtn"; exec.textContent=t("exec");
  exec.onclick=customAct; exec.style.background="#16a34a"; box.appendChild(exec);
  inp.addEventListener("keydown",e=>e.key==="Enter"&&customAct());

  /* ç»“å±€ç”Ÿæˆ */
  const end = document.createElement("button");
  end.id="endBtn"; end.textContent=t("ending");
  end.onclick=endGame; end.style.background="#dc2626"; box.appendChild(end);
}

function disable(){ box.querySelectorAll("button").forEach(b=>b.disabled=true); }

/* â€”â€”â€” å‰ç«¯ä¸»æµç¨‹ â€”â€”â€” */
async function start(){
  resetUI();
  const tags = document.getElementById("tagInput").value
               .split(",").map(s=>s.trim()).filter(Boolean);
  if(!tags.length){ alert(t("placeholder")); return; }

  const d = await api("new",{tags});
  SID = d.sid;
  intro.innerHTML = `ğŸŒ ${d.summary}<br>ğŸ¯ ${d.main_plot}`;
  add(d.event.text);
  renderButtons(d.event.options);
}

async function choose(id){
  disable();
  const d = await api("choice",{choice_id:id});
  add(d.result); add(d.event.text); renderButtons(d.event.options);
}

async function customAct(){
  const inp=document.getElementById("customInput");
  const txt=inp.value.trim(); if(!txt) return; inp.value="";
  const d = await api("choice",{custom_input:txt});
  add(d.result); add(d.event.text); renderButtons(d.event.options);
}

async function endGame(){
  disable(); showLoad();
  const d = await api("end",{}); hideLoad(); box.innerHTML="";
  add(`<b>=== ${d.title} ===</b>`); add(d.ending);
}

/* â€”â€”â€” åˆå§‹åŒ–è¯­è¨€æ–‡æœ¬ â€”â€”â€” */
switchLang(lang);
</script>
</body>
</html>
