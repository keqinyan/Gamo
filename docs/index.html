<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<title>Gamo RPG</title>
<style>
body{font-family:sans-serif;max-width:620px;margin:40px auto;padding:0 12px;color:#222}
.bubble{background:#f6f6f6;border-radius:8px;padding:12px;margin:8px 0}
button{margin:6px 6px 0 0;padding:6px 14px;border:0;border-radius:6px;
       background:#2563eb;color:#fff;font-size:14px;cursor:pointer}
button:disabled{background:#aaa}
/* â”€â”€â”€ åŠ è½½ä¸­çš„è½¬åœˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loader{
  display:none;                 /* é»˜è®¤éšè— */
  border:4px solid #f3f3f3;
  border-top:4px solid #99eb; /* ä¸»é¢˜è‰² */
  border-radius:50%;
  width:32px;height:32px;
  animation: spin 1s linear infinite;
  margin:20px auto;
}
@keyframes spin{
  0%{ transform:rotate(0deg); }
  100%{ transform:rotate(360deg); }
}
.btn{margin:4px;padding:6px 12px;border:0;border-radius:6px;cursor:pointer}
.btnA{background:#99eb;color:#fff}
.btnExec{background:#99a;color:#fff}
.btnEnd{background:#99f;color:#fff}
</style>
</head>
<body>
<h2>ğŸŒŸ Gamo RPG Demo</h2>
<input id="tagInput" style="padding:6px;width:60%" placeholder="è¾“å…¥å…³é”®è¯ï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚â€œç©¿è¶Šï¼Œæç¬‘â€">
<button onclick="start()" style="padding:6px 12px;margin-left:6px">å¼€å§‹å†’é™©</button>
<div id="loader"></div>
<div id="history"></div>
<div id="choices"></div>
<button onclick="restart()" style="margin-top:12px">é‡æ–°å¼€å§‹</button>

<script>
const API="https://gamo.onrender.com";   // â† BACKEND
const hist=document.getElementById("history");
const box=document.getElementById("choices");
const loader = document.getElementById("loader");
function showLoader(){ loader.style.display = "block"; }
function hideLoader(){ loader.style.display = "none"; }


async function api(path, body){
  showLoader();                          // â† å¼€å§‹å‰æ˜¾ç¤º
  const res = await fetch(`${API}/${path}`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  hideLoader();                          // â† æ”¶åˆ°å“åº”åéšè—
  return res.json();
}
function add(text){           // æ¸²æŸ“äº‹ä»¶æ–‡å­—
  hist.innerHTML+=`<div class="bubble">${text.replace(/\\n/g,'<br>')}</div>`;
  window.scrollTo(0,document.body.scrollHeight);
}

function renderButtons(opts){
  const box   = document.getElementById("choices");
  box.innerHTML = "";                       // æ¸…ç©ºæ—§å†…å®¹

  /* ====== 1. A/B/C æŒ‰é’® ====== */
  opts.forEach(o=>{
    const btn=document.createElement("button");
    btn.textContent = `${o.id}. ${o.text}`;
    btn.onclick     = ()=>choose(o.id);
    btn.style = "margin:4px;padding:6px 12px;background:#2563eb;color:#fff;border:0;border-radius:6px;cursor:pointer";
    box.appendChild(btn);
  });

  /* ====== 2. è‡ªç”±è¾“å…¥æ¡† + æ‰§è¡ŒæŒ‰é’® ====== */
  if(opts.length){                          // ç”Ÿæˆäº‹ä»¶æ‰æ˜¾ç¤º
    const input = document.createElement("input");
    input.id = "customInput";
    input.placeholder = "è‡ªç”±è¾“å…¥â€¦";
    input.style = "margin:4px 6px;padding:6px;flex:1";

    const exec = document.createElement("button");
    exec.textContent = "æ‰§è¡Œ";
    exec.onclick     = customAct;
    exec.style = "margin:4px;padding:6px 12px;background:#16a34a;color:#fff;border:0;border-radius:6px;cursor:pointer";

    box.appendChild(input);
    box.appendChild(exec);

    // å›è½¦ç›´æ¥æ‰§è¡Œ
    input.addEventListener("keydown", e=>{
      if(e.key==="Enter") customAct();
    });
  }

  /* ====== 3. ç”Ÿæˆç»“å±€æŒ‰é’® ====== */
  if(opts.length){                          // æœ‰é€‰é¡¹æ—¶æ‰å¯éšæ—¶ç»“å±€
    const endBtn = document.createElement("button");
    endBtn.textContent = "ç”Ÿæˆç»“å±€";
    endBtn.onclick     = endGame;
    endBtn.style = "margin:4px;padding:6px 12px;background:#dc2626;color:#fff;border:0;border-radius:6px;cursor:pointer";
    box.appendChild(endBtn);
  }
}



function disable(){[...box.children].forEach(b=>b.disabled=true);}
async function customAct(){
  const text = document.getElementById("customInput").value.trim();
  if(!text) return;
  document.getElementById("customInput").value="";
  const d = await api("choice", { custom_input: text });
  add(d.result);
  add(d.event.text);
  renderButtons(d.event.options);
}
async function start(){
  hist.innerHTML = "";        // æ¸…å±
  const tags = document.getElementById("tagInput").value
                .split(",").map(s=>s.trim()).filter(Boolean);
  if(!tags.length){
    alert("è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªå…³é”®è¯å¼€å§‹æ¸¸æˆ");
    return;
  }
  const data = await api("new", tags);
  add(data.event.text);
  renderButtons(data.event.options);
}
async function choose(id){
  disable();
  const d = await api("choice", { choice_id: id });   // â˜… å‘é€ JSON å¯¹è±¡
  add(d.result);
  add(d.event.text);
  renderButtons(d.event.options);
}
async function endGame(){
  showLoader();
  const d = await api("end", {});
  hideLoader();

  // å…ˆéšè—è¾“å…¥æ¡†
  const inp = document.getElementById("customInput");
  if (inp) inp.style.display = "none";

  // ç„¶åå†æ¸…ç©ºæŒ‰é’®åŒº
  document.getElementById("choices").innerHTML = "";


  add("=== ç»“å±€ Â· " + d.title + " ===");
  add(d.ending);
}


function restart(){start();}

start();
</script>
</body>
</html>
