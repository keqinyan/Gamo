<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<!-- â‘  è®©æµè§ˆå™¨ç”¨è®¾å¤‡å®½åº¦å¸ƒå±€ã€ç¦æ­¢ç¼©æ”¾ -->
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">

<title>Gamo RPG Demo</title>

<style>
/* â€”â€” é€šç”¨ â€”â€” */
:root{
  --blue:#2563eb;
  --green:#16a34a;
  --red:#dc2626;
  --maxW:620px;
}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  max-width:var(--maxW);
  margin:40px auto;padding:0 12px;color:#222;
}
/* â€”â€” äººç‰© â€”â€” */
.card{border:1px solid #ddd;border-radius:8px;padding:8px;margin:6px 0}
.card h4{margin:4px 0}
.stats span{display:inline-block;width:36px}

/* â€”â€” æ°”æ³¡ â€”â€” */
.bubble{background:#f6f6f6;border-radius:8px;padding:12px;margin:8px 0;}

/* â€”â€” æŒ‰é’® â€”â€” */
button{
  margin:6px 6px 0 0;padding:10px 16px;
  border:0;border-radius:6px;font-size:15px;cursor:pointer;
  background:var(--blue);color:#fff;
}
button:disabled{background:#aaa}

/* â€”â€” Spinner â€”â€” */
#loader{
  display:none;position:fixed;top:50%;left:50%;
  width:40px;height:40px;border:4px solid #eee;border-top:4px solid var(--blue);
  border-radius:50%;animation:spin 1s linear infinite;z-index:9999;
}
/* keyframes åŒæ—¶åŒ…å« translate + rotate */
@keyframes spin{
  0%  {transform:translate(-50%,-50%) rotate(0deg);}
  100%{transform:translate(-50%,-50%) rotate(360deg);}
}
/* â€”â€” è¯­è¨€æ¡†å›ºå®šå³ä¸Š â€”â€” */
#langBox{position:fixed;top:12px;right:12px;z-index:1000;
         background:#fff;padding:4px 6px;border-radius:6px;
         box-shadow:0 0 4px rgba(0,0,0,.08);}
#langBox select{margin-left:4px;padding:4px}

/* â€”â€” æ‰‹æœºç«¯ä¼˜åŒ– â€”â€” */
@media(max-width:480px){
  body{margin:20px 8px;font-size:16px;}
  button{width:100%;margin:6px 0;font-size:16px}
  #tagInput{width:100%;margin-bottom:8px}
  #langBox{position:static;margin-bottom:12px;box-shadow:none}

@keyframes typing{ from{ width:0 } to{ width:100% } }
.typewriter{
  overflow:hidden;white-space:nowrap;border-right:2px solid var(--accent);
  animation:typing 2s steps(30,end), blink .7s step-end infinite;
}
@keyframes blink{ 50%{border-color:transparent} }

/* ç®€æ˜“é®ç½© */
#settingsModal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  padding:20px;background:#fff;border-radius:8px;box-shadow:0 0 10px #0004}
.hidden{display:none}

}
</style>
</head>

<body onload="resetUI()">
<h2>ğŸŒŸ Gamo RPG Demo</h2>

<!-- è¯­è¨€é€‰æ‹© -->
<div id="langBox">
  <label id="langLabel" for="langSel">Language:</label>
  <select id="langSel" onchange="switchLang(this.value)">
    <option value="zh">ä¸­æ–‡</option>
    <option value="en">English</option>
  </select>
  <label><input type="checkbox" id="toggleCG" checked> CG</label>
  <label><input type="checkbox" id="toggleAvatar"> Avatar</label>
</div>

<!-- å…³é”®è¯ + Start -->
<input id="tagInput" placeholder="Enter tags, e.g. isekai, comedy" style="padding:8px;width:60%">
<button id="startBtn" onclick="start()">Start</button>
<input id="tagInput" ...>
<button id="randomBtn" onclick="surprise()">ğŸ² Surprise Me!</button>


<!-- è¿è¡ŒåŒº -->
<div id="loader"></div>
<h3 id="intro"></h3>
<div id="history"></div>
<div id="choices"></div>
<div id="party"></div>
<button id="restartBtn" onclick="restart()">Restart</button>

<script>
/* ========= åŒä¹‹å‰ ========= */
const API="https://gamo.onrender.com";
const hist=document.getElementById("history");
const box =document.getElementById("choices");
const intro=document.getElementById("intro");
const loader=document.getElementById("loader");

const i18n={
  zh:{start:"å¼€å§‹å†’é™©",exec:"æ‰§è¡Œ",ending:"ç”Ÿæˆç»“å±€",restart:"é‡æ–°å¼€å§‹",
      placeholder:"è¾“å…¥å…³é”®è¯ï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚â€œç©¿è¶Š,æç¬‘â€",free:"è‡ªç”±è¾“å…¥â€¦"},
  en:{start:"Start",exec:"Go",ending:"End Story",restart:"Restart",
      placeholder:"Enter tags, e.g. isekai, comedy",free:"Free actionâ€¦"}
};
const PRESETS = [
  "èµ›åšå¿è€…,é²¨é±¼ç¥æ•™", "ç»´å¤šåˆ©äºš,è’¸æ±½æœ‹å…‹,å¸è¡€é¬¼",
  "çŒ«å’ªç‹å›½,å®‡å®™æ­Œå‰§",  "æ ¡å›­æ‹çˆ±,å…‹è‹é²",  // ä»»æ„è„‘æ´
];
function surprise(){
  const kw = PRESETS[Math.floor(Math.random()*PRESETS.length)];
  tagInput.value = kw;
  start();                       // ç›´æ¥å¼€å±€
}

let lang=localStorage.getItem("lang")||"zh";
let SID=null;

function t(k){return i18n[lang][k]||k}
function showLoader(){loader.style.display="block"}
function hideLoader(){loader.style.display="none"}
function restart(){location.reload()}
function switchLang(l){
  lang=l;localStorage.setItem("lang",l);
  document.getElementById("langSel").value=l;        // â† ä¿æŒä¸‹æ‹‰åŒæ­¥
  document.getElementById("startBtn").textContent=t("start");
  document.getElementById("restartBtn").textContent=t("restart");
  document.getElementById("tagInput").placeholder=t("placeholder");
  document.getElementById("langLabel").textContent=(l==="zh")?"è¯­è¨€:":"Language:";
}
function resetUI(){intro.innerHTML="";hist.innerHTML="";box.innerHTML=""}
function add(html){
  hist.insertAdjacentHTML("beforeend",`<div class="bubble">${html}</div>`);
  window.scrollTo(0,document.body.scrollHeight);
}
function renderParty(chars){
  const party = document.getElementById("party");
  party.innerHTML = Object.values(chars).map(c=>`
    <div class="card">
      ${c.avatar_url ? `<img src="${c.avatar_url}" style="width:64px;border-radius:50%">` : ""}
      <h4>${c.name} Â· ${c.role}</h4>
      <div class="stats">
        ${Object.entries(c.stats).map(([k,v])=>`<span>${k}:${v}</span>`).join("")}
      </div>
      <div class="back">${c.backstory}</div>
      <div class="goal">ğŸ¯ ${c.goal}</div>
    </div>`).join("");
}
function add(text){
  hist.insertAdjacentHTML("beforeend",
    `<div class="bubble typewriter">${text.replace(/\\n/g,'<br>')}</div>`);
}
/* æ‰“å¼€ / å…³é—­ */
document.getElementById('settingsBtn').onclick=()=>modal.classList.remove('hidden');
function closeSettings(){ modal.classList.add('hidden'); }

/* å…¨å±€é€‰é¡¹ä¿å­˜ */
let CFG = {
  need_cg   : true,
  need_avatar:false,
  avatar_style:"anime",
};
function closeSettings(){
  CFG.need_cg      = document.getElementById('toggleCG').checked;
  CFG.need_avatar  = document.getElementById('toggleAvatar').checked;
  CFG.avatar_style = document.getElementById('avatarStyle').value;
  modal.classList.add('hidden');
}



async function api(path,body){
  body={...body,lang,sid:SID};
  showLoader();
  const res=await fetch(`${API}/${path}`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body),credentials:"include"});
  hideLoader();
  if(!res.ok){alert(await res.text());throw new Error("api error")}
  return res.json();
}

/* ---------- æ¸¸æˆé€»è¾‘ ---------- */
async function start(){
  resetUI();

  /* 1ï¸âƒ£ æ”¶é›†å…³é”®è¯ */
  const tags = document.getElementById("tagInput").value
                 .split(",").map(s=>s.trim()).filter(Boolean);
  if (!tags.length){ alert(t("placeholder")); return; }

  /* 2ï¸âƒ£ è¯·æ±‚ /new ç”Ÿæˆä¸–ç•Œè§‚ */
  const data = await api("new", {                // â† ç”¨ data æ¥ä½è¿”å›
    tags,
    lang        : lang,                         // å½“å‰è¯­è¨€
    need_avatar : CFG.need_avatar,              // æ˜¯å¦ç”Ÿæˆå¤´åƒ
    avatar_style: CFG.avatar_style              // å¤´åƒé£æ ¼
  });

  /* 3ï¸âƒ£ æ¸²æŸ“è§’è‰²å¡ç‰‡ï¼ˆä¸€å®šæ”¾åœ¨æ‹¿åˆ° data åï¼‰ */
  renderParty(data.characters);

  /* 4ï¸âƒ£ æ˜¾ç¤ºä¸–ç•ŒèƒŒæ™¯ & é¦–å¹•äº‹ä»¶ */
  intro.innerHTML = `ğŸŒ ${data.summary}<br>ğŸ¯ ${data.main_plot}`;
  add(data.event.text);
  renderButtons(data.event.options);

  SID = data.sid;                               // ä¿å­˜ sid ç»™åç»­ /choice /end
}

async function choose(id){
  disable();
  const d=await api("choice",{choice_id:id});
  add(d.result);add(d.event.text);renderButtons(d.event.options);
}

async function customAct(){
  const inp=document.getElementById("customInput");
  const txt=inp.value.trim();if(!txt)return;
  inp.value="";
  const d=await api("choice",{custom_input:txt});
  add(d.result);add(d.event.text);renderButtons(d.event.options);
}

async function endGame(){
  disable();showLoader();
  const d=await api("end",{});
  hideLoader();box.innerHTML="";
  add(`<b>=== ${d.title} ===</b>`);add(d.ending);
}

/* ---------- UI ---------- */
function renderButtons(opts){
  box.innerHTML="";
  opts.forEach(o=>{
    const b=document.createElement("button");
    b.textContent=`${o.id}. ${o.text}`;b.onclick=()=>choose(o.id);
    box.appendChild(b);
  });
  if(opts.length){
    const inp=document.createElement("input");
    inp.id="customInput";inp.placeholder=t("free");
    box.appendChild(inp);

    const exec=document.createElement("button");
    exec.id="execBtn";exec.textContent=t("exec");
    exec.style.background=varCSS("--green");
    exec.onclick=customAct;box.appendChild(exec);

    inp.addEventListener("keydown",e=>e.key==="Enter"&&customAct());

    const end=document.createElement("button");
    end.id="endBtn";end.textContent=t("ending");
    end.style.background=varCSS("--red");
    end.onclick=endGame;box.appendChild(end);
  }
}
function disable(){box.querySelectorAll("button").forEach(b=>b.disabled=true)}
function varCSS(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim()}

/* ---------- åˆå§‹åŒ– ---------- */
switchLang(lang);
</script>
</body>
</html>
