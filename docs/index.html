<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<title>Gamo RPG</title>
<style>
body      {font-family:sans-serif;max-width:620px;margin:40px auto;padding:0 12px;color:#222}
.bubble   {background:#f6f6f6;border-radius:8px;padding:12px;margin:8px 0}
button    {margin:6px 6px 0 0;padding:6px 14px;border:0;border-radius:6px;
           background:#2563eb;color:#fff;font-size:14px;cursor:pointer}
button:disabled{background:#aaa}
/* â”€â”€â”€ Spinner å›ºå®šå±…ä¸­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loader{
  display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #2563eb;border-radius:50%;
  animation:spin 1s linear infinite;z-index:9999;
}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
#langBox{
  position:fixed;
  top:12px;
  right:12px;
  z-index:1000;
  background:#fff;        /* å¯é€‰ï¼šç™½åº•é˜²æŒ¡ä½æ–‡å­— */
  padding:4px 6px;
  border-radius:6px;
  box-shadow:0 0 4px rgba(0,0,0,.08);
}
#langBox select{
  margin-left:4px;
}
</style>
</head>

<body onload="resetUI()">
<h2>ğŸŒŸ Gamo RPG Demo</h2>
<div id="langBox">
<label id="langLabel" for="langSel" style="margin-right:6px">Language:</label>
<select onchange="switchLang(this.value)">
  <option value="zh">ä¸­æ–‡</option>
  <option value="en">English</option>
</select>
</div>

<input id="tagInput" placeholder="è¾“å…¥å…³é”®è¯ï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚â€œç©¿è¶Š,æç¬‘â€" style="padding:6px;width:60%">
<button id="startBtn" onclick="start()">å¼€å§‹å†’é™©</button>

<div id="loader"></div>
<h3 id="intro"></h3>        <!-- ä¸–ç•Œè§‚/ä¸»çº¿å±•ç¤ºåŒº -->
<div id="history"></div>
<div id="choices"></div>
<button id="restartBtn" onclick="restart()" style="margin-top:12px">é‡æ–°å¼€å§‹</button>

<script>
/* â”€â”€â”€ å…¨å±€å˜é‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const API  = "https://gamo.onrender.com";
const hist = document.getElementById("history");
const box  = document.getElementById("choices");
const intro= document.getElementById("intro");
const loader = document.getElementById("loader");

const i18n = {
  zh:{ start:"å¼€å§‹å†’é™©", exec:"æ‰§è¡Œ", ending:"ç”Ÿæˆç»“å±€", restart:"é‡æ–°å¼€å§‹",
       placeholder:"è¾“å…¥å…³é”®è¯ï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚â€œç©¿è¶Š,æç¬‘â€", free:"è‡ªç”±è¾“å…¥â€¦"},
  en:{ start:"Start",     exec:"Go",   ending:"End Story", restart:"Restart",
       placeholder:"Enter tags, e.g. isekai, comedy",     free:"Free actionâ€¦"}
};
let lang = localStorage.getItem("lang") || "zh";

/* â”€â”€â”€ å·¥å…·å‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function t(k){return i18n[lang][k]||k;}
function showLoader(){loader.style.display="block";}
function hideLoader(){loader.style.display="none";}

function switchLang(l){
  lang=l;localStorage.setItem("lang",l);
  document.getElementById("startBtn").textContent = t("start");
  document.getElementById("restartBtn").textContent = t("restart");
  document.getElementById("tagInput").placeholder   = t("placeholder");
  document.getElementById("langLabel").textContent  = (l==="zh")?"è¯­è¨€:":"Language:";
  // choices åŒºé‡Œçš„æŒ‰é’®åœ¨ renderButtons æ—¶ä¼šæ ¹æ® t() æ›´æ–°
}

function resetUI(){
  intro.innerHTML="";
  hist.innerHTML="";
  box.innerHTML="";
}

function add(html){
  hist.insertAdjacentHTML("beforeend",`<div class="bubble">${html}</div>`);
  window.scrollTo(0,document.body.scrollHeight);
}

/* â”€â”€â”€ è°ƒåç«¯ APIï¼ˆè‡ªåŠ¨æºå¸¦ lang & cookieï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function api(path, body){
  body = {...body, lang};
  showLoader();
  const res = await fetch(`${API}/${path}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body),
    credentials:"include"
  });
  hideLoader();
  if(!res.ok){ alert(await res.text()); throw new Error("api error"); }
  return res.json();
}

/* â”€â”€â”€ æ¸²æŸ“æŒ‰é’® + è‡ªç”±è¾“å…¥ + ç»“å±€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderButtons(opts){
  box.innerHTML = "";

  /* A/B/C */
  opts.forEach(o=>{
    const b=document.createElement("button");
    b.textContent=`${o.id}. ${o.text}`;
    b.onclick=()=>choose(o.id);
    btn.style = "margin:4px;padding:6px 12px;background:#2563eb;color:#fff;border:0;border-radius:6px;cursor:pointer";
    box.appendChild(b);
  });

  if(opts.length){
    /* è‡ªç”±è¾“å…¥ */
    const inp=document.createElement("input");
    inp.id="customInput";inp.placeholder=t("free");
    box.appendChild(inp);

    const exec=document.createElement("button");
    exec.id="execBtn";exec.textContent=t("exec");
    exec.onclick=customAct;
    exec.style = "margin:4px;padding:6px 12px;background:#16a34a;color:#fff;border:0;border-radius:6px;cursor:pointer";
    box.appendChild(exec);

    inp.addEventListener("keydown",e=>e.key==="Enter"&&customAct());

    /* ç»“å±€æŒ‰é’® */
    const end=document.createElement("button");
    end.id="endBtn";end.textContent=t("ending");
    end.onclick=endGame;
    end.style.background="#dc2626";
    box.appendChild(end);
  }
}

function disable(){ box.querySelectorAll("button").forEach(b=>b.disabled=true); }

/* â”€â”€â”€ å‰ç«¯é€»è¾‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function start(){
  resetUI();
  const tags = document.getElementById("tagInput").value
               .split(",").map(s=>s.trim()).filter(Boolean);
  if(!tags.length){ alert(t("placeholder")); return; }

  const data = await api("new",{tags});
  intro.innerHTML = `ğŸŒ ${data.summary}<br>ğŸ¯ ${data.main_plot}`;
  add(data.event.text);
  renderButtons(data.event.options);
}

async function choose(id){
  disable();
  const d = await api("choice",{choice_id:id});
  add(d.result);
  add(d.event.text);
  renderButtons(d.event.options);
}

async function customAct(){
  const inp=document.getElementById("customInput");
  const txt=inp.value.trim();
  if(!txt) return;
  inp.value="";
  const d = await api("choice",{custom_input:txt});
  add(d.result);add(d.event.text);
  renderButtons(d.event.options);
}

async function endGame(){
  disable();showLoader();
  const d = await api("end",{});
  hideLoader();box.innerHTML="";
  add(`<b>=== ${d.title} ===</b>`);add(d.ending);
}

/* â”€â”€â”€ è‡ªåŠ¨åˆå§‹åŒ–å½“å‰è¯­è¨€æ–‡æœ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
switchLang(lang);
</script>
</body>
</html>
